<?php
// $Id$

/**
 * @file
 * Unit tests for the xmlsitemap_engines module.
 */
class XMLSitemapEnginesFunctionalTest extends DrupalWebTestCase {
  protected $admin_user;

  public static function getInfo() {
    return array(
      'name' => 'XML sitemap engines interface tests',
      'description' => 'Functional tests for the XML sitemap engines module.',
      'group' => 'XML sitemap',
    );
  }

  function setUp() {
    parent::setUp('xmlsitemap', 'xmlsitemap_engines', 'xmlsitemap_engines_test');
    $this->admin_user = $this->drupalCreateUser(array('access content', 'administer xmlsitemap'));
    $this->drupalLogin($this->admin_user);
  }

  function testPing() {
    $edit = array('xmlsitemap_engines_engines[simpletest]' => TRUE);
    $this->drupalPost('admin/settings/xmlsitemap/engines', $edit, t('Save configuration'));
    $this->assertText(t('The configuration options have been saved.'));

    drupal_cron_run();
    $sent = db_result(db_query_range("SELECT 1 FROM {watchdog} WHERE type = 'xmlsitemap' AND message = 'Submitted the sitemap to %url. !request'", 0, 1));
    $received = db_result(db_query_range("SELECT 1 FROM {watchdog} WHERE type = 'xmlsitemap' AND message = 'Recieved ping for @sitemap.' AND variables = '%s'", serialize(array('@sitemap' => url('sitemap.xml', array('absolute' => TRUE)))), 0, 1));
    $this->assertTrue($sent, t('Sent ping via xmlsitemap_engines_cron().'));
    $this->assertTrue($received, t('Received ping for sitemap.'));
  }
}
